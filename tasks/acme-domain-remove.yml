---
# ============================================================================
# acme-domain-remove.yml
# ----------------------------------------------------------------------------
# Removes a single domain entry from acme.sh tracking + local deployed copies.
#
# Supports BOTH call styles:
#
# New model:
#   acme_domain
#   acme_is_ecc
#   acme_remove_all_variants
#
# Legacy model:
#   item.domains[0]
#   item.remove_all_variants
#
# ECC preference defaults to TRUE.
# ============================================================================

# ---------------------------------------------------------------------------
# 0) Normalize input model (supports both legacy + new callers)
# ---------------------------------------------------------------------------
- name: Normalize domain removal inputs
  ansible.builtin.set_fact:
    _acme_domain: >-
      {{
        acme_domain
        | default(item.domains[0] if (item is defined and item.domains is defined) else none)
      }}

    _acme_remove_all_variants: >-
      {{
        acme_remove_all_variants
        | default(
            item.remove_all_variants
            | default(acme_sh_remove_all_variants
            | default(acme_sh_default_remove_all_variants, true), true),
            true
          )
      }}

    # ECC default = TRUE (your preference)
    _acme_is_ecc: >-
      {{
        acme_is_ecc
        | default(true)
      }}
  changed_when: false

- name: Ensure domain is resolved for removal
  ansible.builtin.assert:
    that:
      - _acme_domain is not none
    fail_msg: "acme-domain-remove.yml called without a resolvable domain"


- name: Check acme.sh binary exists for domain removal
  ansible.builtin.stat:
    path: "{{ acme_sh_bin | default(acme_sh_default_bin, true) }}"
  register: _acme_bin_stat_local
  changed_when: false
  become: true
  become_user: "{{ acme_sh_become_user }}"

- name: Record skip when acme.sh missing (cannot remove domain)
  ansible.builtin.set_fact:
    acme_summary: >-
      {{
        acme_summary
        | combine({
            'skipped': (acme_summary.skipped | default([])) + [{
              'domain': _acme_domain,
              'status': 'skipped',
              'message': 'acme.sh binary missing; cannot remove domain'
            }]
          }, recursive=True)
      }}
  when: not (_acme_bin_stat_local.stat.exists | bool)
  changed_when: true
  tags: [summary]

- name: Skip domain removal because acme.sh is missing
  ansible.builtin.debug:
    msg: "â­ï¸  Skipping removal of {{ _acme_domain }}: acme.sh not installed"
  when: not (_acme_bin_stat_local.stat.exists | bool)
  changed_when: false

# --- Resolve RSA/ECC paths ---
- name: Resolve RSA/ECC paths before removal
  vars:
    acme_domain: "{{ _acme_domain }}"
    acme_is_ecc: "{{ _acme_is_ecc }}"
  ansible.builtin.include_tasks: acme-resolve-rsa-vs-ecc-paths.yml
    apply:
      tags: [always, remove, remove_all, teardown]
  when: _acme_bin_stat_local.stat.exists | bool

# --- Detect RSA + ECC internal directories ---
- name: Check for RSA and ECC certificate directories
  ansible.builtin.stat:
    path: "{{ candidate.path }}"
  loop:
    - { name: "RSA", path: "{{ acme_sh_directory_resolved }}/{{ _acme_domain }}" }
    - { name: "ECC", path: "{{ acme_sh_directory_resolved }}/{{ _acme_domain }}_ecc" }
  loop_control:
    loop_var: candidate
    label: "{{ candidate.name }}"
  register: _variant_dir_stat
  changed_when: false
  become: true
  become_user: "{{ acme_sh_become_user }}"
  when: _acme_bin_stat_local.stat.exists | bool

- name: Set variant existence flags
  ansible.builtin.set_fact:
    _has_rsa_variant: >-
      {{ (_variant_dir_stat.results
          | selectattr('item.name','equalto','RSA')
          | map(attribute='stat.exists') | first) | default(false) }}
    _has_ecc_variant: >-
      {{ (_variant_dir_stat.results
          | selectattr('item.name','equalto','ECC')
          | map(attribute='stat.exists') | first) | default(false) }}
    _has_both_variants: "{{ (_has_rsa_variant | bool) and (_has_ecc_variant | bool) }}"
  changed_when: false
  when: _acme_bin_stat_local.stat.exists | bool

# --- Warn if both exist ---
- name: Warn if both RSA and ECC directories exist for this domain
  ansible.builtin.warn:
    msg: >-
      Both RSA and ECC certificate directories exist for {{ _acme_domain }}.
      Resolved removal target: {{ acme_sh_cert_path_resolved }}.
      remove_all_variants={{ _acme_remove_all_variants }}.
  when:
    - _has_both_variants | bool
    - _acme_bin_stat_local.stat.exists | bool

# STEP 1 â€” Stop tracking with acme.sh
- name: Remove domain from acme.sh tracking (best effort)
  vars:
    acme_exe: "{{ acme_sh_bin | default(acme_sh_default_bin, true) }}"
    _cmds: >-
      {{
        (
          [ acme_exe ~ ' --remove -d ' ~ _acme_domain,
            acme_exe ~ ' --remove -d ' ~ _acme_domain ~ ' --ecc' ]
          if (_has_both_variants | bool and _acme_remove_all_variants | bool)
          else
          [ acme_exe ~ ' --remove -d ' ~ _acme_domain ~ (' --ecc' if _acme_is_ecc else '') ]
        )
      }}
  ansible.builtin.shell: "{{ cmd }}"
  args:
    chdir: "{{ acme_sh_directory_resolved }}"
    executable: "{{ bash_executable_path | default('/bin/bash') }}"
  loop: "{{ _cmds }}"
  loop_control:
    loop_var: cmd
  register: acme_remove_cmds
  failed_when: false
  changed_when: false
  become: true
  become_user: "{{ acme_sh_become_user }}"
  when: _acme_bin_stat_local.stat.exists | bool

- name: Classify removal outcome (removed vs already_absent vs failed)
  ansible.builtin.set_fact:
    _remove_rcs: "{{ (acme_remove_cmds.results | default([])) | map(attribute='rc') | list }}"
    _removed_now: "{{ (_remove_rcs | select('equalto', 0) | list | length) > 0 }}"
    _already_absent: "{{ (not _removed_now) and ((_remove_rcs | select('equalto', 2) | list | length) > 0) }}"
    _remove_failed: "{{ (not _removed_now) and (not _already_absent) }}"
  changed_when: false
  when:
    - _acme_bin_stat_local.stat.exists | bool
    - acme_remove_cmds is defined

# STEP 2 â€” Remove internal certificate directories
- name: Remove BOTH RSA and ECC internal cert directories (optional)
  ansible.builtin.file:
    path: "{{ candidate.path }}"
    state: absent
  loop:
    - { name: "RSA", path: "{{ acme_sh_directory_resolved }}/{{ _acme_domain }}" }
    - { name: "ECC", path: "{{ acme_sh_directory_resolved }}/{{ _acme_domain }}_ecc" }
  loop_control:
    loop_var: candidate
    label: "{{ candidate.name }}"
  when:
    - _has_both_variants | bool
    - _acme_remove_all_variants | bool
    - _acme_bin_stat_local.stat.exists | bool
  become: true
  become_user: "{{ acme_sh_become_user }}"

- name: Remove resolved internal certificate directory (default)
  ansible.builtin.file:
    path: "{{ acme_sh_cert_path_resolved }}"
    state: absent
  when:
    - not (_has_both_variants | bool and _acme_remove_all_variants | bool)
    - _acme_bin_stat_local.stat.exists | bool
  become: true
  become_user: "{{ acme_sh_become_user }}"

# STEP 3 â€” Remove deployed cert copies
- name: Remove deployed certificate directory if it exists
  ansible.builtin.file:
    path: "{{ (acme_sh_copy_certs_to_path | default(acme_sh_default_copy_certs_to_path, true)) }}/{{ _acme_domain }}"
    state: absent
  become: true
  failed_when: false
  when:
    - _acme_bin_stat_local.stat.exists | bool
  
# STEP 4 â€” Record result
- name: Record domain removal result
  ansible.builtin.set_fact:
    acme_summary: >-
      {{
        acme_summary
        | combine({
            'removed': (
              (acme_summary.removed | default([])) + [{
                'domain': _acme_domain,
                'removed_all_variants': _acme_remove_all_variants
              }]
            ) if (_removed_now | bool) else (acme_summary.removed | default([])),

            'skipped': (
              (acme_summary.skipped | default([])) + [{
                'domain': _acme_domain,
                'status': 'already_absent',
                'message': 'Domain not found in acme.sh; nothing to remove',
                'removed_all_variants': _acme_remove_all_variants
              }]
            ) if (_already_absent | bool) else (acme_summary.skipped | default([])),

            'failed': (
              (acme_summary.failed | default([])) + [{
                'domain': _acme_domain,
                'message': 'acme.sh --remove failed',
                'rcs': (_remove_rcs | default([])),
                'removed_all_variants': _acme_remove_all_variants
              }]
            ) if (_remove_failed | bool) else (acme_summary.failed | default([]))
          }, recursive=True)
      }}
  changed_when: true
  when:
    - _acme_bin_stat_local.stat.exists | bool
    - acme_remove_cmds is defined

# STEP 5 â€” Feedback
- name: Show per-domain removal result
  ansible.builtin.debug:
    msg: >-
      {{
        (
          'ðŸ—‘ï¸  Removed ' ~ _acme_domain ~
          (' (all variants)' if (_acme_remove_all_variants | bool) else '')
        ) if (_removed_now | bool) else
        (
          'â­ï¸  Already absent ' ~ _acme_domain
        ) if (_already_absent | bool) else
        (
          'âŒ Failed to remove ' ~ _acme_domain
        )
      }}
  when:
    - _acme_bin_stat_local.stat.exists | bool
    - acme_remove_cmds is defined

- name: Snapshot scoreboard after domain removal (verbose mode only)
  ansible.builtin.include_tasks: debug-acme-scoreboard.yml
    apply:
      tags: [always, remove, remove_all, teardown]
  when:
    - ansible_verbosity | int >= 2
    - _acme_bin_stat_local.stat.exists | bool
  tags: debug
