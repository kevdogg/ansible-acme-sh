---
---
# ============================================================================
# acme-domain-remove.yml
# ----------------------------------------------------------------------------
# Purpose:
#   Handles safe and complete removal of ACME-managed certificates for a domain.
#   This includes:
#     â€¢ Stopping acme.sh tracking for the target domain
#     â€¢ Removing associated internal certificate directories (RSA/ECC)
#     â€¢ Deleting deployed copies from /etc/ssl/letsencrypt/<domain>
#     â€¢ Updating the global scoreboard with results and warnings
#
# Scope:
#   Runs once per domain entry (looped from acme_sh_domains).
#   Complements the domain workflow by cleaning up obsolete or retired domains.
#
# Notes:
#   - Uses resolve-rsa-vs-ecc-paths.yml to determine which cert variant to remove.
#   - Detects and warns if both RSA and ECC directories exist (dual-cert case).
#   - Appends â€˜removedâ€™ and â€˜failedâ€™ results to the acme_summary scoreboard.
#
# Version: 2025.11.07 / compatible with acme.sh â‰¥ 3.0.8
# Maintainer: KevDog
# Tags: [acme, letsencrypt, cleanup, remove, rsa, ecc]
# ============================================================================


# --- Resolve RSA/ECC paths for domain cleanup ---
# This sets: acme_sh_directory_resolved, acme_sh_domain_resolved, acme_sh_cert_path_resolved
- name: Resolve RSA/ECC paths before removal
  ansible.builtin.include_tasks: acme-resolve-rsa-vs-ecc-paths.yml
  vars:
    item: "{{ item }}"

# STEP 0.5 â€” Detect dual-cert situations (RSA + ECC)
- name: Check for both RSA and ECC certificate directories
  ansible.builtin.stat:
    path: "{{ candidate.path }}"
    loop:
    - { name: "RSA", path: "{{ acme_sh_directory_resolved }}/{{ item.domains[0] }}" }
    - { name: "ECC", path: "{{ acme_sh_directory_resolved }}/{{ item.domains[0] }}_ecc" }
  loop_control:
    loop_var: candidate
  register: dual_cert_check
  become: true
  become_user: "{{ acme_sh_become_user }}"

# STEP 0.6 â€” Warn visibly + add to scoreboard if both exist
- name: Warn if both RSA and ECC directories exist for this domain
  ansible.builtin.debug:
    msg: >-
      âš ï¸  Both RSA and ECC certificate directories exist for {{ item.domains[0] }}.
      This may indicate mixed certificate usage.
      Current removal target: {{ acme_sh_cert_path_resolved }}
  when:
    - dual_cert_check.results | selectattr('stat.exists') | list | length == 2
  changed_when: true         # show as "changed" in recap
  warn: true                 # emit yellow/orange WARNING banner
  tags: warn
  register: dual_cert_warning

- name: Append dual-cert warning to scoreboard
  ansible.builtin.set_fact:
    acme_summary: >-
      {{
        acme_summary
        | combine({
            'warnings': (acme_summary.warnings + [{
              'domain': item.domains[0],
              'message': 'Both RSA and ECC certificate directories exist.',
              'path_rsa': acme_sh_directory_resolved ~ '/' ~ item.domains[0],
              'path_ecc': acme_sh_directory_resolved ~ '/' ~ item.domains[0] ~ '_ecc'
            }])
            if (dual_cert_check.results | selectattr('stat.exists') | list | length == 2)
            else acme_summary.warnings
          }, recursive=True)
      }}
  when:
    - dual_cert_check.results | selectattr('stat.exists') | list | length == 2
  changed_when: true
  tags: warn


# STEP 1 â€” Stop tracking with acme.sh
- name: "acme.sh --remove -d {{ item.domains[0] }}"
  vars:
    acme_exe: "{{ acme_sh_bin | default(acme_sh_default_bin, true) }}"
  ansible.builtin.shell: >-
    {{
      acme_exe ~ ' --remove -d ' ~ item.domains[0] ~
      (
        ' --ecc'
        if (
          item.acme_sh_extra_flags
          | default(acme_sh_default_extra_flags, true)
          | has_flag('--ecc')
        )
        else ''
      )
    }}
  args:
    chdir: "{{ acme_sh_directory_resolved }}"
    executable: "{{ bash_executable_path | default('/bin/bash') }}"
  register: acme_remove_result
  failed_when: acme_remove_result.rc not in [0, 2]  # 2 = "nothing to remove"
  changed_when: acme_remove_result.rc == 0
  become: true
  become_user: "{{ acme_sh_become_user }}"

# STEP 2 â€” Remove acme.sh internal certificate files (RSA or ECC)
- name: Check for presence of acme_sh_cert_path_resolved directory
  ansible.builtin.stat:
    path: "{{ acme_sh_cert_path_resolved }}"
  register: acme_sh_cert_path_resolved_result
  become: true
  become_user: "{{ acme_sh_become_user }}"

- name: Remove internal certificate files (RSA/ECC)
  ansible.builtin.file:
    path: "{{ acme_sh_cert_path_resolved }}"
    state: absent
  when: acme_sh_cert_path_resolved_result.stat.exists | default(false)
  become: true
  become_user: "{{ acme_sh_become_user }}"

# STEP 3 â€” Remove installed certificate copies (/etc/ssl/letsencrypt/<domain>)
- name: Check if deployed certificate directory exists
  ansible.builtin.stat:
    path: "{{ acme_sh_copy_certs_to_path }}/{{ item.domains | first }}"
  register: deployed_dir_result
  failed_when: false
  become: true
  become_user: "{{ acme_sh_become_user | default(omit) }}"

- name: Remove deployed certificate directory if it exists
  ansible.builtin.file:
    path: "{{ acme_sh_copy_certs_to_path }}/{{ item.domains | first }}"
    state: absent
  when: deployed_dir_result.stat.exists | default(false)
  become: true
  become_user: "{{ acme_sh_become_user | default(omit) }}"
  changed_when: deployed_dir_result.stat.exists | default(false)

# STEP 4 â€” Record result in scoreboard
- name: Record domain removal result
  ansible.builtin.set_fact:
    acme_domain_status: >-
      {{ 
        'removed' if acme_remove_result.rc == 0
        else 'skipped' if acme_remove_result.rc == 2
        else 'failed' 
      }}
    acme_domain_result:
      domain: "{{ item.domains[0] }}"
      domains: "{{ item.domains }}"
      status: "{{ acme_domain_status }}"
      rc_remove: "{{ acme_remove_result.rc }}"
      stdout_remove: "{{ acme_remove_result.stdout | default('') }}"
  when: acme_remove_result is defined

# STEP 5 â€” Append result to scoreboard
- name: Append removal result to scoreboard
  ansible.builtin.set_fact:
    acme_summary: >-
      {{
        acme_summary
        | combine({
            'removed': (acme_summary.removed + [acme_domain_result])
                        if acme_domain_status == 'removed' else acme_summary.removed,
            'failed':  (acme_summary.failed  + [acme_domain_result])
                        if acme_domain_status == 'failed' else acme_summary.failed
            'skipped': (acme_summary.skipped + [acme_domain_result])
                        if acme_domain_status == 'skipped' else acme_summary.skipped,
          }, recursive=True)
      }}
  when: acme_domain_status is defined

# STEP 6 â€” Immediate visual feedback
- name: Show per-domain removal result
  ansible.builtin.debug:
    msg: >-
      {{
        (
          'ðŸ—‘ï¸  Successfully removed ' ~ item.domains[0]
          if acme_domain_status == 'removed'
          else 'âŒ Failed to remove ' ~ item.domains[0]
        )
      }}
  when: acme_domain_status is defined

# Optional: show scoreboard snapshot (verbose mode)
- name: Snapshot scoreboard after domain removal (verbose mode only)
  ansible.builtin.include_tasks: debug-acme-scoreboard.yml
  when: ansible_verbosity | int >= 2
  tags: debug

