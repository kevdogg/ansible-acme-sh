---
# Resolve all ACME paths & executables in a single place.
# Safe to include multiple times (idempotent). Evaluates after host/group overrides.

- name: Resolve acme.sh home directory (host override aware)
  ansible.builtin.set_fact:
    acme_sh_directory_resolved: >-
      {{
        (acme_sh_directory
          | default(acme_sh_default_directory, true)
          | default('~/.acme.sh'))
        | expanduser
      }}

# acme.sh binary location derived from the resolved home
- name: Resolve acme.sh binary path
  ansible.builtin.set_fact:
    acme_sh_bin: "{{ acme_sh_directory_resolved }}/acme.sh"

# Resolve install/target directory for deployed certs (localcopy hook)
- name: Resolve target install path for certificates
  ansible.builtin.set_fact:
    acme_sh_copy_certs_to_path_resolved: >-
      {{
        (acme_sh_copy_certs_to_path
          | default(acme_sh_default_copy_certs_to_path, true)
          | default('/etc/ssl/letsencrypt'))
        | expanduser
      }}

# Resolve systemd unit directory
- name: Resolve systemd unit directory for acme services/timers
  ansible.builtin.set_fact:
    acme_sh_systemd_service_dir: >-
      {{
        acme_sh_systemd_service_location
          | default(acme_sh_default_systemd_service_location, true)
          | default('/etc/systemd/system')
      }}

# Resolve service & timer filenames (do not expanduser; they are filenames)
- name: Resolve systemd unit filenames
  ansible.builtin.set_fact:
    acme_sh_systemd_service_name: >-
      {{
        acme_sh_systemd_service_name
          | default(acme_sh_default_systemd_service_name, true)
          | default('acme_letsencrypt.service')
      }}
    acme_sh_systemd_timer_name: >-
      {{
        acme_sh_systemd_timer_name
          | default(acme_sh_default_systemd_timer_name, true)
          | default('acme_letsencrypt.timer')
      }}

# Compose full paths (dir + filename)
- name: Compose systemd unit full paths
  ansible.builtin.set_fact:
    acme_sh_systemd_service_path: "{{ acme_sh_systemd_service_dir }}/{{ acme_sh_systemd_service_name }}"
    acme_sh_systemd_timer_path:   "{{ acme_sh_systemd_service_dir }}/{{ acme_sh_systemd_timer_name }}"

# Optional: resolve bash executable (keeps your tasks consistent)
- name: Resolve bash executable path
  ansible.builtin.set_fact:
    bash_executable_path: >-
      {{
        bash_executable_path
          | default(acme_sh_default_bash_executable_path, true)
          | default('/bin/bash')
      }}

- name: Resolve bash executable path
  ansible.builtin.set_fact:
    acme_sh_bin: "{{ bash_executable_path }}"

# Optional: resolve openssl path if you previously detected it
# (Use your which_openssl_result if present; else fall back to 'openssl' in PATH)
- name: Resolve openssl path (optional)
  ansible.builtin.set_fact:
    openssl_path: >-
      {{
        (which_openssl_result.stdout | default('') | trim)
          if (which_openssl_result is defined and (which_openssl_result.rc | default(1)) == 0)
          else (acme_sh_default_openssl_path | default('openssl'))
      }}

