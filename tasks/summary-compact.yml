---
# COMPACT SCOREBOARD SUMMARY â€” compares planned vs actual results
# ---------------------------------------------------------------

- name: ACME Summary â€” Compare plan vs actual results (with color summary bar)
  vars:
    cat_icons:
      installed: "ğŸŸ¢"
      renewed:   "ğŸŸ¡"
      skipped:   "âšª"
      removed:   "ğŸ”µ"
      failed:    "ğŸ”´"
    planned_count: "{{ acme_plan_summary.total | default(acme_sh_domains | length | default(0)) }}"
    installed_count: "{{ acme_summary.installed | length | default(0) }}"
    renewed_count: "{{ acme_summary.renewed | length | default(0) }}"
    removed_count: "{{ acme_summary.removed | length | default(0) }}"
    skipped_count: "{{ acme_summary.skipped | length | default(0) }}"
    failed_count: "{{ acme_summary.failed | length | default(0) }}"
    actual_count: "{{ installed_count + renewed_count + removed_count + skipped_count + failed_count }}"
    success_count: "{{ installed_count + renewed_count + removed_count + skipped_count }}"
    percent_success: >-
      {{
        ((success_count | float) / (planned_count | float) * 100)
        | round(1)
        if planned_count | int > 0 else 100
      }}
    _planned_domains: "{{ acme_plan_summary.domains | default([]) }}"
    _actual_domains: "{{ (acme_summary.installed + acme_summary.renewed + acme_summary.removed + acme_summary.failed + acme_summary.skipped)
                        | map(attribute='domains')
                        | list | flatten | unique | default([]) }}"
    _unprocessed: "{{ _planned_domains | difference(_actual_domains) }}"
    _unexpected: "{{ _actual_domains | difference(_planned_domains) }}"
  ansible.builtin.debug:
    msg: |
      â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
      â”‚                  ğŸŒ ACME Certificate Summary                 â”‚
      â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

      ğŸ“Š **Overall Status**
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      ğŸŸ¢ {{ installed_count }} installed
      ğŸŸ¡ {{ renewed_count }} renewed
      ğŸ”µ {{ removed_count }} removed
      âšª {{ skipped_count }} skipped
      ğŸ”´ {{ failed_count }} failed
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      Planned domains: {{ planned_count }}
      Processed domains: {{ actual_count }}
      âœ… Success rate: {{ percent_success }}%

      {% if failed_count | int > 0 %}
        âŒ Some operations failed â€” review logs for details.
      {% else %}
        âœ… All operations completed successfully.
      {% endif %}

      {% if acme_sh_show_plan_deltas | default(true) %}
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      {% if _unprocessed | length > 0 %}
      âš ï¸  Planned but not processed:
      {% for d in _unprocessed %}
        â€¢ {{ d }}
      {% endfor %}
      {% endif %}
      {% if _unexpected | length > 0 %}
      âš ï¸  Unexpectedly processed (not in plan):
      {% for d in _unexpected %}
        â€¢ {{ d }}
      {% endfor %}
      {% endif %}
      {% endif %}

      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      {% for category, entries in acme_summary.items() %}
        {% if entries | length > 0 %}
      {{ cat_icons[category] }} **{{ category | upper }}** â€” {{ entries | length }} item(s)
      {% for entry in entries %}
        â–¶ {{ entry.domains | join(', ') }}
          Status: {{ entry.status | upper }}
          {% if entry.new_days_remaining is defined %}
            Valid for: {{ entry.new_days_remaining }} days
          {% endif %}
          {% if entry.force_renew | default(false) %}
            ğŸ” Force renew enabled
          {% endif %}
          {% if category == 'failed' %}
            âŒ Failure reason: {{ entry.reason_failed | default('unknown') }}
            Return codes: issue={{ entry.rc_issue | default('-') }},
                          renew={{ entry.rc_renew | default('-') }},
                          pkcs={{ entry.rc_pkcs | default('-') }},
                          deploy={{ entry.rc_deploy | default('-') }}
          {% endif %}
          {% if entry.live_cert_path is defined %}
            Path: {{ entry.live_cert_path }}
          {% endif %}
      {% endfor %}
        {% endif %}
      {% endfor %}

      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      ğŸŸ¢ installed | ğŸŸ¡ renewed | ğŸ”µ removed | âšª skipped | ğŸ”´ failed
  when: acme_summary is defined
  tags: summary

