---
# ============================================================================
# acme-plan.yml (NEW format only)
# ----------------------------------------------------------------------------
# Assumes acme.sh --list output like:
# Main_Domain KeyLength SAN_Domains Profile CA Created Renew
# ============================================================================

- name: PLAN â€” parse acme.sh list (host)
  ansible.builtin.include_tasks: acme-parse-list.yml
  vars:
    acme_list_fail_on_error: true
    acme_list_compute_status: true
  tags: plan

# 5. Legend
- name: PLAN â€” Legend
  ansible.builtin.debug:
    msg: |
      âœ… Renewal not needed (>30 days until next renew date)
      ğŸŸ¡ Renewal recommended (â‰¤30 days)
      ğŸ”´ Renewal urgent (â‰¤10 days)
      ğŸ†• First issuance (no cert exists)
      âš ï¸  Using default PKCS#12 password
  run_once: true
  tags: plan

# 6. INSTALL entries (includes "managed already" or "first issue")
- name: PLAN â€” INSTALL domains
  ansible.builtin.debug:
    msg: |
      â–¶ Domains: {{ item.domains | join(', ') }}
         Action: INSTALL
         PKCS12 password: {{ item.acme_sh_pkcs12_password | default(acme_sh_default_pkcs12_password) }}
      {% if item.acme_sh_pkcs12_password is not defined %}
        âš ï¸  Using default PKCS#12 password: '{{ acme_sh_default_pkcs12_password }}'
      {% endif %}
      {% set domain0 = item.domains[0] %}
      {% if acme_cert_info is defined and acme_cert_info[domain0] is defined %}
         Renew in: {{ acme_cert_info[domain0].days_remaining }} days {{ acme_renew_status[domain0].emoji }}
         Next renew date: {{ acme_cert_info[domain0].renew }}
         Renewal urgency: {{ acme_renew_status[domain0].urgency }}
      {% else %}
         Status: n/a ğŸ†•
         Renewal urgency: FIRST ISSUE
      {% endif %}
      {% if item.install_cert_reloadcmd is defined %}
         Reload after install: {{ item.install_cert_reloadcmd }}
      {% endif %}
  loop: "{{ acme_sh_domains }}"
  when:
    - acme_sh_domains | default([]) | length > 0
    - not (item.remove | default(false))
    - not (item.force_renew | default(false))
  tags: plan

# 6.1 FORCE_RENEW entries
- name: PLAN â€” FORCE_RENEW domains
  ansible.builtin.debug:
    msg: |
      â–¶ Domains: {{ item.domains | join(', ') }}
         Action: FORCE_RENEW
         PKCS12 password: {{ item.acme_sh_pkcs12_password | default(acme_sh_default_pkcs12_password) }}
      {% if item.acme_sh_pkcs12_password is not defined %}
        âš ï¸  Using default PKCS#12 password: '{{ acme_sh_default_pkcs12_password }}'
      {% endif %}
      {% set domain0 = item.domains[0] %}
      {% if acme_cert_info is defined and acme_cert_info[domain0] is defined %}
         Renew in: {{ acme_cert_info[domain0].days_remaining }} days {{ acme_renew_status[domain0].emoji }}
         Next renew date: {{ acme_cert_info[domain0].renew }}
         Renewal urgency: {{ acme_renew_status[domain0].urgency }}
      {% else %}
         Status: n/a ğŸ†•
         Renewal urgency: FIRST ISSUE
      {% endif %}
      {% if item.install_cert_reloadcmd is defined %}
         Reload after renew: {{ item.install_cert_reloadcmd }}
      {% endif %}
  loop: "{{ acme_sh_domains }}"
  when:
    - acme_sh_domains | default([]) | length > 0
    - not (item.remove | default(false))
    - (item.force_renew | default(false))
  tags: plan

# 7. REMOVE entries
- name: PLAN â€” REMOVE domains
  ansible.builtin.debug:
    msg: |
      â–¶ Domains: {{ item.domains | join(', ') }}
         Action: REMOVE
         PKCS12 password: {{ item.acme_sh_pkcs12_password | default(acme_sh_default_pkcs12_password) }}
      {% set domain0 = item.domains[0] %}
      {% if acme_cert_info is defined and acme_cert_info[domain0] is defined %}
         Renew in: {{ acme_cert_info[domain0].days_remaining }} days {{ acme_renew_status[domain0].emoji }}
         Next renew date: {{ acme_cert_info[domain0].renew }}
      {% else %}
         Status: n/a ğŸ†•
      {% endif %}
  loop: "{{ acme_sh_domains }}"
  when:
    - acme_sh_domains | default([]) | length > 0
    - (item.remove | default(false))
  tags: plan

# 8. Export structured plan summary (domain actions first)
- name: PLAN â€” Export structured plan summary (domain actions)
  ansible.builtin.set_fact:
    acme_plan_summary:
      total: "{{ acme_sh_domains | length | default(0) }}"
      default_pw_count: "{{ acme_sh_domains | selectattr('acme_sh_pkcs12_password', 'undefined') | list | length }}"
      domains: "{{ acme_sh_domains | map(attribute='domains') | list | flatten }}"
      domain_actions: >-
        {%- set m = {} -%}
        {%- for d in (acme_sh_domains | default([])) -%}
        {%-   set dom = d.domains[0] -%}
        {%-   set act = (
               'REMOVE' if (d.remove | default(false)) else
               'FORCE_RENEW' if (d.force_renew | default(false)) else
               'INSTALL'
             ) -%}
        {%-   set _ = m.update({ dom: {'action': act} }) -%}
        {%- endfor -%}
        {{ m }}
  when: acme_sh_domains is defined and acme_sh_domains | length > 0
  tags: plan

# 8.1 Derive counts from domain_actions (no drift)
- name: PLAN â€” Derive plan counts from domain_actions
  ansible.builtin.set_fact:
    acme_plan_summary: >-
      {{
        acme_plan_summary | combine({
          'installs': (acme_plan_summary.domain_actions | dict2items | selectattr('value.action','equalto','INSTALL') | list | length),
          'renews':   (acme_plan_summary.domain_actions | dict2items | selectattr('value.action','equalto','FORCE_RENEW') | list | length),
          'removes':  (acme_plan_summary.domain_actions | dict2items | selectattr('value.action','equalto','REMOVE') | list | length)
        }, recursive=True)
      }}
  when: acme_plan_summary is defined
  tags: plan

# 9. Compact visual summary
- name: Include compact plan summary
  ansible.builtin.include_tasks: acme-plan-summary-compact.yml
  when: acme_sh_domains | default([]) | length > 0
  tags: plan
