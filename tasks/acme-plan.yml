---
# 1. Gather ACME cert info
- name: PLAN â€” gather existing ACME cert info
  ansible.builtin.command: >
    {{ acme_sh_bin }} --list
  register: acme_list_result
  changed_when: false
  failed_when: false
  tags: plan
  become: yes
  become_user: "{{ acme_sh_become_user }}"

# 2. Normalize and parse the table lines
- name: PLAN â€” parse ACME cert table (robust)
  vars:
    _lines: >-
      {{
        acme_list_result.stdout_lines
        | select('match', '^\|')
        | map('regex_replace', '^\|\s*', '')
        | map('regex_replace', '\s*\|$', '')
        | map('split', '|')
        | map('map', 'trim')
      }}
  ansible.builtin.set_fact:
    acme_cert_table: "{{ _lines }}"
  when: _lines | length > 1
  tags: plan

# 3. Create domainâ†’days mapping regardless of column order
- name: PLAN â€” extract main domain and remaining days (flexible)
  vars:
    header: "{{ acme_cert_table[0] | map('trim') | list }}"
    rows: "{{ acme_cert_table[1:] }}"
  ansible.builtin.set_fact:
    acme_cert_info: >-
      {{
        dict(rows | map('zip', header) | map('items') | map('dict')
        | map('extract', {'Main_Domain': 'domain', 'Days_remaining': 'days',
                          'Main Domain': 'domain', 'Remaining Days': 'days'})   # fallback keys
        | map('combine', {}) | map(attribute='domain', value='days')
        | select('defined') | list)
      }}
  when:
    - acme_cert_table is defined
    - acme_cert_table | length > 1
  tags: plan

# 4. Compute urgency + emoji safely
- name: PLAN â€” compute renewal urgency and emoji
  ansible.builtin.set_fact:
    acme_renew_status: >-
      {{
        acme_cert_info | dict2items
        | map('combine', {
            'urgency': (
              'OK' if (item.value | int) > 30 else
              'SOON' if (item.value | int) > 10 else
              'URGENT'
            ),
            'emoji': (
              'âœ…' if (item.value | int) > 30 else
              'ðŸŸ¡' if (item.value | int) > 10 else
              'ðŸ”´'
            )
          })
        | items2dict(key='key', value='value')
      }}
  when: acme_cert_info is defined
  tags: plan

# 5. Print legend only if expiration data exists
- name: PLAN â€” Legend
  ansible.builtin.debug:
    msg: |
      âœ… Healthy (>30 days)
      ðŸŸ¡ Renewal recommended (â‰¤30 days)
      ðŸ”´ Renewal urgent (â‰¤10 days)
      ðŸ†• First issuance (no cert exists)
      âš ï¸  Using default PKCS#12 password
  run_once: true
  tags: plan

# 6. INSTALL/RENEW entries
- name: PLAN â€” INSTALL/RENEW domains
  ansible.builtin.debug:
    msg: |
      â–¶ Domains: {{ item.domains | join(', ') }}
         Action: INSTALL/RENEW
         PKCS12 password: {{ item.acme_sh_pkcs12_password | default(acme_sh_default_pkcs12_password) }}
      {% if item.acme_sh_pkcs12_password is not defined %}
        âš ï¸  Using default PKCS#12 password: '{{ acme_sh_default_pkcs12_password }}'
      {% endif %}
      {% if acme_cert_info is defined and acme_cert_info[item.domains[0]] is defined %}
         Expires in: {{ acme_cert_info[item.domains[0]] }} days {{ acme_renew_status[item.domains[0]].emoji }}
         Renewal urgency: {{ acme_renew_status[item.domains[0]].urgency }}
      {% else %}
         Expires in: n/a ðŸ†•
         Renewal urgency: FIRST ISSUE
      {% endif %}
      {% if item.install_cert_reloadcmd is defined %}
         Reload after install: {{ item.install_cert_reloadcmd }}
      {% endif %}
  loop: "{{ acme_sh_domains }}"
  when:
    - acme_sh_domains | default([]) | length > 0
    - not item.remove | default(false)
  tags: plan

# 7. REMOVE entries
- name: PLAN â€” REMOVE domains
  ansible.builtin.debug:
    msg: |
      â–¶ Domains: {{ item.domains | join(', ') }}
         Action: REMOVE
         PKCS12 password: {{ item.acme_sh_pkcs12_password | default(acme_sh_default_pkcs12_password) }}
      {% if acme_cert_info is defined and acme_cert_info[item.domains[0]] is defined %}
         Remaining validity: {{ acme_cert_info[item.domains[0]] }} days {{ acme_renew_status[item.domains[0]].emoji }}
      {% else %}
         Remaining validity: n/a ðŸ†•
      {% endif %}
  loop: "{{ acme_sh_domains }}"
  when:
    - acme_sh_domains | default([]) | length > 0
    - item.remove | default(false)
  tags: plan

