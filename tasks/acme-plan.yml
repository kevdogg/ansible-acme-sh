---
# 1. Gather ACME cert info
- name: PLAN â€” gather existing ACME cert info
  ansible.builtin.command: >
    {{ acme_sh_bin }} --list
  register: acme_list_result
  changed_when: false
  failed_when: false
  become: true
  become_user: "{{ acme_sh_become_user }}"
  tags: plan

# 2. Detect format (old pipe table vs new space-separated)
- name: PLAN â€” detect acme.sh --list format
  ansible.builtin.set_fact:
    _acme_lines: "{{ acme_list_result.stdout_lines | reject('match', '^\\s*$') | list }}"
    _is_pipe_format: "{{ _acme_lines | select('match', '^\\|') | list | length > 0 }}"
  tags: plan

# 3A. Parse NEW format (space-column style)
- name: PLAN â€” parse NEW format (space-column)
  when: not _is_pipe_format and _acme_lines | length > 1
  vars:
    _rows_raw: "{{ _acme_lines[1:] }}"
    _rows_split: >-
      {{
        _rows_raw
        | map('regex_replace', '\\s+', ' ')
        | map('trim')
        | map('split', ' ')
        | list
      }}
    _mapped: >-
      {{
        _rows_split
        | map('extract', {0: 'domain', 4: 'created', 5: 'renew'})
        | map('combine', {})
        | map('combine', {
            'days_remaining': (
              ((item.renew | to_datetime) - (ansible_date_time.iso8601 | to_datetime)).days
            )
          })
        | list
      }}
  ansible.builtin.set_fact:
    acme_cert_info: >-
      {{
        dict(_mapped | map('community.general.dict_kv', 'key', 'domain', 'value', omit='') | list)
      }}
  tags: plan

# 3B. Parse OLD format (pipe-table style)
- name: PLAN â€” parse OLD format (pipe-table)
  when: _is_pipe_format
  vars:
    _lines: >-
      {{
        _acme_lines
        | select('match', '^\\|')
        | map('regex_replace', '^\\|\\s*', '')
        | map('regex_replace', '\\s*\\|$', '')
        | map('split', '|')
        | map('map', 'trim')
        | list
      }}
    _header: "{{ _lines[0] | map('trim') | list }}"
    _rows: "{{ _lines[1:] }}"
    _domain_key: >-
      {{
        (_header | select('search', 'Main[ _]Domain') | list | first) | default('Main_Domain')
      }}
    _days_key: >-
      {{
        (_header | select('search', 'Days_remaining|Remaining Days') | list | first) | default('Days_remaining')
      }}
    _rowdicts: >-
      {{
        _rows
        | map('zip', _header)
        | map('items')
        | map('dict')
        | list
      }}
    _mapped: >-
      {{
        _rowdicts
        | map('extract', {_domain_key: 'domain', _days_key: 'days_remaining'})
        | map('combine', {})
        | list
      }}
  ansible.builtin.set_fact:
    acme_cert_info: >-
      {{
        dict(_mapped | map('community.general.dict_kv', 'key', 'domain', 'value', omit='') | list)
      }}
  tags: plan

# 4. Compute urgency + emoji safely
- name: PLAN â€” compute renewal urgency and emoji
  ansible.builtin.set_fact:
    acme_renew_status: >-
      {{
        acme_cert_info | dict2items
        | map('combine', {
            'urgency': (
              'OK' if (item.value.days_remaining | int) > 30 else
              'SOON' if (item.value.days_remaining | int) > 10 else
              'URGENT'
            ),
            'emoji': (
              'âœ…' if (item.value.days_remaining | int) > 30 else
              'ğŸŸ¡' if (item.value.days_remaining | int) > 10 else
              'ğŸ”´'
            )
          })
        | items2dict(key='key', value='value')
      }}
  when: acme_cert_info is defined
  tags: plan

# 5. Legend
- name: PLAN â€” Legend
  ansible.builtin.debug:
    msg: |
      âœ… Healthy (>30 days)
      ğŸŸ¡ Renewal recommended (â‰¤30 days)
      ğŸ”´ Renewal urgent (â‰¤10 days)
      ğŸ†• First issuance (no cert exists)
      âš ï¸  Using default PKCS#12 password
  run_once: true
  tags: plan

# 6. INSTALL/RENEW entries
- name: PLAN â€” INSTALL/RENEW domains
  ansible.builtin.debug:
    msg: |
      â–¶ Domains: {{ item.domains | join(', ') }}
         Action: INSTALL/RENEW
         PKCS12 password: {{ item.acme_sh_pkcs12_password | default(acme_sh_default_pkcs12_password) }}
      {% if item.acme_sh_pkcs12_password is not defined %}
        âš ï¸  Using default PKCS#12 password: '{{ acme_sh_default_pkcs12_password }}'
      {% endif %}
      {% set domain0 = item.domains[0] %}
      {% if acme_cert_info is defined and acme_cert_info[domain0] is defined %}
         Expires in: {{ acme_cert_info[domain0].days_remaining }} days {{ acme_renew_status[domain0].emoji }}
         Renewal urgency: {{ acme_renew_status[domain0].urgency }}
      {% else %}
         Expires in: n/a ğŸ†•
         Renewal urgency: FIRST ISSUE
      {% endif %}
      {% if item.install_cert_reloadcmd is defined %}
         Reload after install: {{ item.install_cert_reloadcmd }}
      {% endif %}
  loop: "{{ acme_sh_domains }}"
  when:
    - acme_sh_domains | default([]) | length > 0
    - not item.remove | default(false)
  tags: plan

# 7. REMOVE entries
- name: PLAN â€” REMOVE domains
  ansible.builtin.debug:
    msg: |
      â–¶ Domains: {{ item.domains | join(', ') }}
         Action: REMOVE
         PKCS12 password: {{ item.acme_sh_pkcs12_password | default(acme_sh_default_pkcs12_password) }}
      {% set domain0 = item.domains[0] %}
      {% if acme_cert_info is defined and acme_cert_info[domain0] is defined %}
         Remaining validity: {{ acme_cert_info[domain0].days_remaining }} days {{ acme_renew_status[domain0].emoji }}
      {% else %}
         Remaining validity: n/a ğŸ†•
      {% endif %}
  loop: "{{ acme_sh_domains }}"
  when:
    - acme_sh_domains | default([]) | length > 0
    - item.remove | default(false)
  tags: plan

# 8. PLAN â€” Export structured summary for comparison
- name: PLAN â€” Export structured plan summary (domain + aggregate)
  ansible.builtin.set_fact:
    acme_plan_summary:
      total: "{{ acme_sh_domains | length | default(0) }}"
      installs: "{{ acme_sh_domains | rejectattr('remove', 'defined') | list | length }}"
      renews: "{{ acme_sh_domains | selectattr('force_renew', 'defined') | selectattr('force_renew') | list | length }}"
      removes: "{{ acme_sh_domains | selectattr('remove', 'defined') | selectattr('remove') | list | length }}"
      default_pw_count: "{{ acme_sh_domains | selectattr('acme_sh_pkcs12_password', 'undefined') | list | length }}"
      domains: "{{ acme_sh_domains | map(attribute='domains') | list | flatten }}"
      domain_actions: >-
        {{
          dict(acme_sh_domains
            | map('community.general.dict_kv', 'key', 'domains.0',
                  'value', {'action': ('REMOVE' if (item.remove | default(false)) else 'INSTALL')})
            | list)
        }}
  when: acme_sh_domains is defined and acme_sh_domains | length > 0
  tags: plan

# 9. PLAN â€” Compact visual summary
- name: Include compact plan summary
  ansible.builtin.include_tasks: acme-plan-summary-compact.yml
  when: acme_sh_domains | default([]) | length > 0
  tags: plan

