---
# ============================================================================
# acme-install-acme-sh.yml
# ----------------------------------------------------------------------------
# Purpose:
#   Handles installation, configuration, and maintenance of acme.sh from Git.
#   Ensures the local environment has a working copy of acme.sh, properly
#   configured with:
#     • Git clone or update of the acme.sh repository
#     • Installation into the target home directory (usually ~/.acme.sh)
#     • Optional upgrade and CA authority configuration
#     • Optional notification hook setup (email, Slack, etc.)
#     • Creation of the installation and certificate directories
#     • Deployment of systemd service and timer units
#     • Enabling and starting the renewal timer automatically
#
# Notes:
#   - All tasks use become/become_user for safety and privilege consistency.
#   - Safe to re-run; idempotent where possible.
#   - Explicit "Systemd Daemon Reload" step retained for clarity.
#
# Maintainer: KevDog
# Version: 2025.11.07 / compatible with acme.sh ≥ 3.0.8
# Tags: [acme, letsencrypt, automation, setup, systemd, notifications]
# ============================================================================

- name: Determine if acme.sh is installed
  ansible.builtin.stat:
    path: "{{ acme_sh_bin }}"
  register: is_acme_sh_installed
  become: true
  become_user: "{{ acme_sh_become_user }}"

- name: Ensure acme.sh home directory exists
  ansible.builtin.file:
    path: "{{ acme_sh_directory_resolved }}"
    state: directory
    mode: '0755'
  when:
    - not (is_acme_sh_installed.stat.exists | bool)
  become: true
  become_user: "{{ acme_sh_become_user }}"

- name: Determine if acme.sh git repository is cloned locally
  ansible.builtin.stat:
    path: "{{ (item.acme_sh_git_clone_dest | default(acme_sh_default_git_clone_dest)) ~ '/.git' }}"
  register: is_acme_sh_cloned_locally
  become: true
  become_user: "{{ acme_sh_become_user }}"

- name: Create acme.sh git clone directory if it does not exist
  ansible.builtin.file:
    path: "{{ item.acme_sh_git_clone_dest | default(acme_sh_default_git_clone_dest) }}"
    state: directory
    mode: '0755'
  when:
    - not (is_acme_sh_cloned_locally.stat.exists | bool)
  become: true
  become_user: "{{ acme_sh_become_user }}"

- name: Git Clone https://github.com/acmesh-official/acme.sh.git
  ansible.builtin.git:
    repo: "{{ item.acme_sh_git_url | default(acme_sh_default_git_url) }}"
    depth: 1
    clone: true
    force: "{{ (item.acme_sh_git_clone_force | default(acme_sh_default_git_clone_force | default(false))) | bool }}"
    dest: "{{ item.acme_sh_git_clone_dest | default(acme_sh_default_git_clone_dest) }}"
    version: "{{ item.acme_sh_git_version | default(acme_sh_default_git_version) }}"
  when:
    - not (is_acme_sh_cloned_locally.stat.exists | bool)
  become: true
  become_user: "{{ acme_sh_become_user }}"

- name: Update Git Clone https://github.com/acmesh-official/acme.sh.git if already exists
  ansible.builtin.git:
    repo: "{{ item.acme_sh_git_url | default(acme_sh_default_git_url) }}"
    update: yes
    clone: no
    dest: "{{ item.acme_sh_git_clone_dest | default(acme_sh_default_git_clone_dest) }}"
  become: true
  become_user: "{{ acme_sh_become_user }}"
  when:
    - is_acme_sh_cloned_locally.stat.exists | bool

- name: Install acme.sh
  vars:
    acme_exe: "{{ acme_sh_bin | default(acme_sh_default_bin, true) }}"
  ansible.builtin.shell: >-
    {{
      acme_exe ~ ' --install' ~
      ' --accountemail "' ~ (item.acme_sh_account_email | default(acme_sh_default_account_email)) ~ '"' ~
      ' --home ' ~ acme_sh_directory_resolved ~
      ' --nocron'
    }}
  args:
    chdir: "{{ item.acme_sh_git_clone_dest | default(acme_sh_default_git_clone_dest | default('/root/.acme.sh')) }}"
    creates: "{{ acme_sh_bin }}"
    executable: "{{ bash_executable_path }}"
  when:
    - not (is_acme_sh_installed.stat.exists | bool)
  become: true
  become_user: "{{ acme_sh_become_user }}"
  register: install_acme_sh_result
  changed_when: install_acme_sh_result.rc == 0
  failed_when: install_acme_sh_result.rc != 0

- name: Upgrade acme.sh
  vars:
    acme_exe: "{{ acme_sh_bin | default(acme_sh_default_bin, true) }}"
  ansible.builtin.shell: >-
    {{
      acme_exe ~ ' --upgrade --auto-upgrade'
    }}
  args:
    chdir: "{{ acme_sh_directory_resolved }}"
    executable: "{{ bash_executable_path }}"
  when:
    - acme_sh_upgrade | default(acme_sh_default_upgrade | default(true)) | bool
  register: upgrade_result
  changed_when: upgrade_result.rc == 0 and "Upgrade success" in upgrade_result.stdout
  failed_when: upgrade_result.rc != 0
  become: true
  become_user: "{{ acme_sh_become_user }}"

- name: Use given CA authority - default Let'sEncrypt
  vars:
    acme_exe: "{{ acme_sh_bin | default(acme_sh_default_bin, true) }}"
  ansible.builtin.shell: >-
    {{
      acme_exe ~ ' --set-default-ca --server ' ~
      (item.acme_sh_server | default(acme_sh_default_server | default('')))
    }}
  args:
    chdir: "{{ acme_sh_directory_resolved }}"
    executable: "{{ bash_executable_path }}"
  when:
    - not (is_acme_sh_installed.stat.exists | bool)
    - (item.acme_sh_server | default(acme_sh_default_server | default('letsencrypt'))) | length > 0
  become: true
  become_user: "{{ acme_sh_become_user }}"
  register: acme_default_server_result
  changed_when: acme_default_server_result.rc == 0
  failed_when: acme_default_server_result.rc != 0

- name: Create acme.sh install directory -- Default(/etc/ssl/letsencrypt)
  ansible.builtin.file:
    path: "{{ item.acme_sh_copy_certs_to_path | default(acme_sh_default_copy_certs_to_path) }}"
    state: directory
    owner: "{{ acme_sh_become_user }}"
    group: "{{ acme_sh_become_user }}"
    mode: "{{ item.acme_sh_install_directory_permissions | default(acme_sh_default_install_directory_permissions) }}"
  become: true
  become_user: "{{ acme_sh_become_user }}"

- name: Enable acme.sh notification
  vars:
    acme_exe: "{{ acme_sh_bin | default(acme_sh_default_bin, true) }}"
  ansible.builtin.shell: >-
    {{
      acme_exe ~ ' --set-notify' ~
      ' --notify-level ' ~ (acme_sh_notify_level | default(acme_sh_default_notify_level | default('2'))) ~
      ' --notify-mode ' ~ (acme_sh_notify_mode | default(acme_sh_default_notify_mode | default('0'))) ~
      (acme_sh_notify_hooks | map('regex_replace', '^(.*)$', ' --notify-hook \\1') | join(''))
    }}
  args:
    chdir: "{{ acme_sh_directory_resolved }}"
    executable: "{{ bash_executable_path }}"
  environment: "{{ acme_sh_notify_env_var }}"
  when:
    - acme_sh_enable_notify
    - acme_sh_notify_hooks | length > 0
    - acme_sh_notify_env_var.keys() | length > 0
  become: true
  become_user: "{{ acme_sh_become_user }}"
  register: acme_notify_result
  changed_when: acme_notify_result.rc == 0
  failed_when: acme_notify_result.rc != 0
  tags: notify

- name: Install {{ systemd_service_name }}.service
  ansible.builtin.template:
    src: acme_letsencrypt.service.j2
    dest: "{{ acme_sh_systemd_service_path | default(acme_sh_default_systemd_service_path) }}"
    force: true
    owner: root
    group: root
    mode: '0644'
  become: true
  become_user: "{{ acme_sh_become_user }}"

- name: Install {{ systemd_timer_name }}.timer
  ansible.builtin.template:
    src: acme_letsencrypt.timer.j2
    dest: "{{ acme_sh_systemd_timer_path | default(acme_sh_default_systemd_timer_path) }}"
    force: true
    owner: root
    group: root
    mode: '0644'
  become: true
  become_user: "{{ acme_sh_become_user }}"

- name: Systemd Daemon Reload
  ansible.builtin.systemd_service:
    daemon_reload: true
  become: true
  become_user: "{{ acme_sh_become_user }}"

- name: Determine if systemd timer file exists
  ansible.builtin.stat:
    path: "{{ acme_sh_systemd_timer_path | default(acme_sh_default_systemd_timer_path) }}"
  register: systemd_timer_file_exists_result
  become: true
  become_user: "{{ acme_sh_become_user }}"

- name: Determine if systemd service file exists
  ansible.builtin.stat:
    path: "{{ acme_sh_systemd_service_path | default(acme_sh_default_systemd_service_path) }}"
  register: systemd_service_file_exists_result
  become: true
  become_user: "{{ acme_sh_become_user }}"

- name: Enable and start acme.sh systemd timer for renewals
  ansible.builtin.systemd_service:
    name: "{{ acme_sh_systemd_timer_name }}"
    enabled: true
    state: started
    daemon_reload: true
  when:
    - systemd_timer_file_exists_result.stat.exists
    - systemd_service_file_exists_result.stat.exists
  become: true
  become_user: "{{ acme_sh_become_user }}"

