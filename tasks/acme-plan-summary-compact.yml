---
# ============================================================================
# acme-plan-summary-compact.yml
# ----------------------------------------------------------------------------
# Purpose:
#   Generates a concise preflight summary (â€œPLANâ€ view) showing all domains
#   scheduled for issuance, renewal, or removal. Highlights certificate health
#   and renewal urgency using color-coded indicators.
#
# Scope:
#   Executed during planning phase before any issuance or removal occurs.
#   Pulls data from acme-plan.yml and summarizes actions for operator review.
#
# Notes:
#   - Works with both modern (space-column) and legacy (pipe-table) acme.sh output.
#   - Displays âœ…ğŸŸ¡ğŸ”´ status indicators based on remaining certificate days.
#   - Produces acme_plan_summary for later comparison to final execution results.
#
# Version: 2025.11.07 / compatible with acme.sh â‰¥ 3.0.8
# Maintainer: KevDog
# Tags: [acme, letsencrypt, plan, preflight, summary]
# ============================================================================


- name: PLAN SUMMARY â€” Compact preflight table
  vars:
    cat_icons:
      INSTALL:     "ğŸŸ¢"
      FORCE_RENEW: "ğŸŸ¡"
      REMOVE:      "ğŸ”µ"
    install_count: "{{ acme_plan_summary.installs | default(0) }}"
    force_renew_count: "{{ acme_plan_summary.renews | default(0) }}"
    remove_count: "{{ acme_plan_summary.removes | default(0) }}"
    total_count: "{{ acme_plan_summary.total | default(0) }}"
    default_pw_count: "{{ acme_plan_summary.default_pw_count | default(0) }}"
    _actual_domains: "{{ (acme_summary.installed + acme_summary.renewed + acme_summary.removed + acme_summary.failed + acme_summary.skipped)
                        | map(attribute='domains')
                        | list | flatten | unique | default([]) }}"
    _planned_domains: "{{ acme_plan_summary.domains | default([]) }}"
    _unprocessed: "{{ _planned_domains | difference(_actual_domains) }}"
  ansible.builtin.debug:
    msg: |
      â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
      â”‚             ğŸŒ ACME Certificate Preflight Summary             â”‚
      â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

      ğŸ“Š **Planned Actions**
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      ğŸŸ¢ {{ install_count }} install(s)
      ğŸŸ¡ {{ force_renew_count }} force renew(s)
      ğŸ”µ {{ remove_count }} remove(s)
      âš ï¸  {{ default_pw_count }} using default PKCS#12 password
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      Total domains in plan: {{ total_count }}

      {% if total_count | int == 0 %}
      âš ï¸  No domains to process.
      {% endif %}

      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      {% for domain, meta in acme_plan_summary.domain_actions.items() %}
      {{ cat_icons[meta.action] | default('âšª') }} {{ domain }} â†’ {{ meta.action }}
      {% endfor %}

      {% if acme_sh_show_plan_deltas | default(true) and _unprocessed | length > 0 %}
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      âš ï¸  Planned but not processed (not yet in scoreboard):
      {% for d in _unprocessed %}
        â€¢ {{ d }}
      {% endfor %}
      {% endif %}

      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      Legend:
        ğŸŸ¢ INSTALL
        ğŸŸ¡ FORCE_RENEW
        ğŸ”µ REMOVE
        âš ï¸  Default password in use ('pass')
        ğŸ†•  No existing certificate
  when: acme_plan_summary is defined
  tags: plan

