---
########################
# PreTasks
#######################
- name: Debug to Show all ansible variable
  ansible.builtin.debug:
    msg: item
  loop: "{{ acme_sh_domains }}" 
  become_user: "{{ acme_sh_become_user }}"
  tags:
    - debug

# Prepare a structure for tracking results
# Lists will be appended during execution
- name: Initialize ACME summary scoreboard
  ansible.builtin.set_fact:
    acme_summary:
      installed: "{{ acme_summary.installed | default([]) }}"
      renewed: "{{ acme_summary.renewed | default([]) }}"
      skipped: "{{ acme_summary.skipped | default([]) }}"
      removed: "{{ acme_summary.removed | default([]) }}"
      failed: "{{ acme_summary.failed | default([]) }}"
      warnings: "{{ acme_summary.warnings | default([]) }}"
  tags: always

- name: Resolve ACME paths and executables
  ansible.builtin.include_tasks:
    file: acme-resolve-acme-paths.yml
  tags: always

- name: acme.sh Plan
  ansible.builtin.include_tasks:
    file: acme-plan.yml
  tags: plan

# Show preflight summary
- name: Display preflight plan summary
  ansible.builtin.include_tasks: acme-plan-summary-compact.yml
  tags: plan

########################
# Issue/Renew Phase
#######################

# ============================================================================
# Install acme.sh (Per-Host Setup)
# ----------------------------------------------------------------------------
# Includes:
#   - Git clone and installation of acme.sh
#   - Directory and environment setup
#   - Systemd timer/service creation for auto-renewals
#   - Optional notification configuration
# ============================================================================
- name: Install acme.sh if not installed
  ansible.builtin.include_tasks:
    file: acme-install-acme-sh.yml
  when:
    - not (acme_sh_uninstall | default(acme_sh_default_uninstall | default(false)) | bool)
  tags: install_acme.sh


### Issue/Renew and Deploy acme.sh certs
### Includes Force renew and acme.sh custom command
- name: Obtain and Install/Renew acme.sh certificates
  ansible.builtin.include_tasks:
    file:  acme_domain-workflow.yml
  loop: "{{ acme_sh_domains }}"
  loop_control:
    label: "{{ item.domains[0] }}"
  when:
    - acme_sh_domains is defined and acme_sh_doamin | length > 0
    - item.domains is defined and item.domains | length > 0
    - not item.remove | default(false) | bool
    - not (acme_sh_uninstall | default(acme_sh_default_uninstall | default(false)) | bool)

############################
# Remove Certificate Phase
############################

### Remove/Inactivate Certificates (Per Domain Task)
- name: Process ACME domain removals
  ansible.builtin.include_tasks: acme-domain-remove.yml
  loop: "{{ acme_sh_domains }}"
  loop_control:
    label: "{{ item.domains[0] }}"
  when:
    - acme_sh_domains is defined and acme_sh_domains | length > 0
    - item.domains is defined and item.domains | length > 0
    - item.remove | default(false) | bool
    - not (acme_sh_uninstall | default(acme_sh_default_uninstall | default(false)) | bool)

############################
# Remove All Phase
############################
## Uninstall everything -- Uninstall acme.sh and all issued certificates and remove all timers/service files
- name: ðŸ§¹ Full ACME teardown (remove all certs, services, and acme.sh)
  ansible.builtin.include_tasks:
    file: acme-remove-all.yml
  when:
    - acme_sh_uninstall | default(acme_sh_default_uninstall | default(false)) | bool
  tags: [remove_all, teardown]

# ==========================================================
# ðŸ§© Developer / Diagnostic Section
# ----------------------------------------------------------
# Validates custom filter plugins such as:
#   - has_flag
#   - add_flag_if_missing
#   - ensure_flags_present
#   - remove_flag
#
# Supports both:
#   â€¢ Standalone mode  â†’  ansible-playbook tasks/test-filters.yml
#   â€¢ Integrated mode  â†’  ansible-playbook main.yml --tags test-filters -vvv
# ==========================================================

- name: Run filter plugin test suite (developer debug only)
  ansible.builtin.include_tasks:
    file: test-filters.yml
  when:
    - ansible_verbosity | int >= 3
    - "'test-filters' in ansible_run_tags"
  tags: [debug, test-filters]

# ==========================================================
# ðŸ“‹ Final Compact Summary
# ----------------------------------------------------------
# Always runs at end-of-role unless disabled.
# Shows installed / renewed / removed / failed domains,
# with optional plan delta comparison.
# ==========================================================

- name: Include final summary
  ansible.builtin.include_tasks: acme-summary-compact.yml
  when:
    - acme_summary is defined
  tags: summary


