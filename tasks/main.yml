---
# ============================================================================
# main.yml â€” ACME.SH Role Entry Point
# ----------------------------------------------------------------------------
# Purpose:
#   Central task orchestrator for ACME certificate lifecycle management.
#   This role automates installation, issuance, renewal, and teardown of
#   acme.sh-managed certificates across multiple domains.
#
# Includes:
#   â€¢ acme-install-acme-sh.yml       â†’ Installs acme.sh and systemd setup
#   â€¢ acme-domain-workflow.yml       â†’ Handles per-domain issue/renew/deploy
#   â€¢ acme-domain-remove.yml         â†’ Handles selective domain removal
#   â€¢ acme-remove-all.yml            â†’ Performs full uninstallation
#   â€¢ acme-plan.yml / summary files  â†’ Preflight and postflight reports
#   â€¢ test-filters.yml               â†’ Developer-only plugin validation
#
# Tag model:
#   - plan ............: Build & display preflight plan
#   - workflow ........: Issue / renew / deploy certificates
#   - install_acme.sh .: Install acme.sh + setup systemd timer/service
#   - remove ..........: Remove selected domain(s)
#   - remove_all ......: Full uninstall and cleanup
#   - summary .........: Compact post-execution report
#   - debug ...........: Diagnostic output (skippable with --skip-tags debug)
#   - test-filters ....: Developer-only plugin test suite
#
# Version: 2025.11.09
# Maintainer: KevDog
# Tags: [acme, letsencrypt, workflow, automation, lifecycle, debug]
# ============================================================================

# Normalize uninstall boolean once (so you donâ€™t repeat default() chains)
- name: Normalize uninstall toggle
  ansible.builtin.set_fact:
    _acme_uninstall: "{{ (acme_sh_uninstall | default(acme_sh_default_uninstall, true)) | bool }}"
  tags: [always]

########################
# Ensure acme is installed
########################
# IMPORTANT:
# - Do NOT run this during full uninstall
# - Do NOT tag it with "remove" (domain-remove still needs acme.sh present, but you can install if missing anyway)
- name: Install acme.sh if not installed
  ansible.builtin.include_tasks:
    file: acme-install-acme-sh.yml
    apply:
      tags: [install, wokflow, plan]
  when: not _acme_uninstall
  tags: [install, workflow, plan]

########################
# PreTasks
########################

- name: Debug to show all ACME domain variables
  ansible.builtin.debug:
    msg: "{{ item | default('No domain object') }}"
  loop: "{{ acme_sh_domains | default([]) }}"
  become: true
  become_user: "{{ acme_sh_become_user }}"
  tags: [debug]

- name: Initialize ACME summary scoreboard
  ansible.builtin.set_fact:
    acme_summary:
      installed: "{{ acme_summary.installed | default([]) }}"
      renewed:   "{{ acme_summary.renewed   | default([]) }}"
      skipped:   "{{ acme_summary.skipped   | default([]) }}"
      removed:   "{{ acme_summary.removed   | default([]) }}"
      failed:    "{{ acme_summary.failed    | default([]) }}"
      warnings:  "{{ acme_summary.warnings  | default([]) }}"
  tags: [always]

########################
# Plan Phase
########################
# If user runs --tags plan, this runs (and only then).
- name: Generate ACME preflight plan
  ansible.builtin.include_tasks:
    file: acme-plan.yml
    apply:
      tags: [plan]
  when:
    - not _acme_uninstall
    - "'plan' in ansible_run_tags"
  tags: [plan]

########################
# Issue / Renew Phase
########################

- name: Obtain and install/renew acme.sh certificates
  ansible.builtin.include_tasks:
    file: acme-domain-workflow.yml
    apply:
      tags: [workflow]
  loop: "{{ acme_sh_domains | default([]) }}"
  loop_control:
    label: "{{ item.domains[0] | default('UNKNOWN') }}"
  when:
    - not _acme_uninstall
    - acme_sh_domains is defined
    - acme_sh_domains | length > 0
    - item.domains is defined
    - item.domains | length > 0
    - not (item.remove | default(false) | bool)
  tags: [workflow]

############################
# Remove Certificate Phase
############################

- name: Process ACME domain removals
  ansible.builtin.include_tasks:
    file: acme-domain-remove.yml
    apply:
      tags: [remove]
  loop: "{{ acme_sh_domains | default([]) }}"
  loop_control:
    label: "{{ item.domains[0] | default('UNKNOWN') }}"
  when:
    - not _acme_uninstall
    - acme_sh_domains is defined
    - acme_sh_domains | length > 0
    - item.domains is defined
    - item.domains | length > 0
    - item.remove | default(false) | bool
  tags: [remove]

############################
# Full Uninstall Phase
############################

- name: ðŸ§¹ Full ACME teardown (remove all certs, services, and acme.sh)
  ansible.builtin.include_tasks:
    file: acme-remove-all.yml
    apply:
      tags: [remove_all, teardown]
  when: _acme_uninstall
  tags: [remove_all, teardown]

############################
# Developer / Diagnostic
############################

# Removed â€” dev only
# include_tasks: test-filters.yml

############################
# Final Summary
############################

- name: Include final summary
  ansible.builtin.include_tasks:
    file: acme-summary-compact.yml
    apply:
      tags: [summary]
  when:
    - acme_summary is defined
    - "'plan' not in ansible_run_tags"
  tags: [summary]
