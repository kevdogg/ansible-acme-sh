---
# ============================================================================
# main.yml â€” ACME.SH Role Entry Point
# ----------------------------------------------------------------------------
# Purpose:
#   Central task orchestrator for ACME certificate lifecycle management.
#   This role automates installation, issuance, renewal, and teardown of
#   acme.sh-managed certificates across multiple domains.
#
# Includes:
#   â€¢ acme-install-acme-sh.yml       â†’ Installs acme.sh and systemd setup
#   â€¢ acme-domain-workflow.yml       â†’ Handles per-domain issue/renew/deploy
#   â€¢ acme-domain-remove.yml         â†’ Handles selective domain removal
#   â€¢ acme-remove-all.yml            â†’ Performs full uninstallation
#   â€¢ acme-plan.yml / summary files  â†’ Preflight and postflight reports
#   â€¢ test-filters.yml               â†’ Developer-only plugin validation
#
# Tag model:
#   - plan ............: Build & display preflight plan
#   - workflow ........: Issue / renew / deploy certificates
#   - install_acme.sh .: Install acme.sh + setup systemd timer/service
#   - remove ..........: Remove selected domain(s)
#   - remove_all ......: Full uninstall and cleanup
#   - summary .........: Compact post-execution report
#   - debug ...........: Diagnostic output (skippable with --skip-tags debug)
#   - test-filters ....: Developer-only plugin test suite
#
# Version: 2025.11.09
# Maintainer: KevDog
# Tags: [acme, letsencrypt, workflow, automation, lifecycle, debug]
# ============================================================================


########################
# PreTasks
########################

- name: Debug to show all ACME domain variables
  ansible.builtin.debug:
    msg: "{{ item }}"
  loop: "{{ acme_sh_domains }}"
  become_user: "{{ acme_sh_become_user }}"
  tags: [debug]

- name: Initialize ACME summary scoreboard
  ansible.builtin.set_fact:
    acme_summary:
      installed: "{{ acme_summary.installed | default([]) }}"
      renewed:   "{{ acme_summary.renewed | default([]) }}"
      skipped:   "{{ acme_summary.skipped | default([]) }}"
      removed:   "{{ acme_summary.removed | default([]) }}"
      failed:    "{{ acme_summary.failed | default([]) }}"
      warnings:  "{{ acme_summary.warnings | default([]) }}"
  tags: [always]

- name: Resolve ACME paths and executables
  ansible.builtin.include_tasks: acme-resolve-acme-paths.yml
  tags: [setup]

- name: Generate ACME preflight plan
  ansible.builtin.include_tasks: acme-plan.yml
  tags: [plan]

- name: Display preflight plan summary
  ansible.builtin.include_tasks: acme-plan-summary-compact.yml
  tags: [plan]


########################
# Issue / Renew Phase
########################

- name: Install acme.sh if not installed
  ansible.builtin.include_tasks: acme-install-acme-sh.yml
  when:
    - not (acme_sh_uninstall | default(acme_sh_default_uninstall | default(false)) | bool)
  tags: [install_acme.sh, workflow]

- name: Obtain and install/renew acme.sh certificates
  ansible.builtin.include_tasks: acme-domain-workflow.yml
  loop: "{{ acme_sh_domains }}"
  loop_control:
    label: "{{ item.domains[0] }}"
  when:
    - acme_sh_domains is defined and acme_sh_domains | length > 0
    - item.domains is defined and item.domains | length > 0
    - not item.remove | default(false) | bool
    - not (acme_sh_uninstall | default(acme_sh_default_uninstall | default(false)) | bool)
  tags: [workflow]


############################
# Remove Certificate Phase
############################

- name: Process ACME domain removals
  ansible.builtin.include_tasks: acme-domain-remove.yml
  loop: "{{ acme_sh_domains }}"
  loop_control:
    label: "{{ item.domains[0] }}"
  when:
    - acme_sh_domains is defined and acme_sh_domains | length > 0
    - item.domains is defined and item.domains | length > 0
    - item.remove | default(false) | bool
    - not (acme_sh_uninstall | default(acme_sh_default_uninstall | default(false)) | bool)
  tags: [remove]


############################
# Full Uninstall Phase
############################

- name: ðŸ§¹ Full ACME teardown (remove all certs, services, and acme.sh)
  ansible.builtin.include_tasks: acme-remove-all.yml
  when:
    - acme_sh_uninstall | default(acme_sh_default_uninstall | default(false)) | bool
  tags: [remove_all, teardown]


############################
# Developer / Diagnostic
############################

- name: Run filter plugin test suite (developer debug only)
  ansible.builtin.include_tasks: test-filters.yml
  when:
    - "'test-filters' in ansible_run_tags"
  tags: [test-filters]


############################
# Final Summary
############################

- name: Include final summary
  ansible.builtin.include_tasks: acme-summary-compact.yml
  when:
    - acme_summary is defined
  tags: [summary]

