---
# Purpose: Parse the output of `acme.sh --list` into structured facts.
# Supports both the old pipe-table and new space-column formats.

- name: Normalize lines and detect format
  ansible.builtin.set_fact:
    _all_lines: "{{ (acme_list.stdout_lines | default([])) | reject('match', '^\\s*$') | list }}"
    _is_pipe_table: "{{ (_all_lines | select('match', '^\\|') | list | length) > 0 }}"
  when: acme_list is defined
  changed_when: false

# -------------------------------------------------------------------------
# PARSER: NEW FORMAT (space-column) with quoted token support
# -------------------------------------------------------------------------
- name: Parse NEW acme.sh --list format
  when:
    - acme_list is defined
    - (_all_lines | length) > 1
    - not _is_pipe_table
  vars:
    _token_re: '"[^"]*"|\\S+'
    _header_tokens: >-
      {{
        (_all_lines[0] | regex_findall(_token_re))
        | map('regex_replace','^\"(.*)\"$','\\1')
        | list
      }}
    _idx_domain: "{{ _header_tokens.index('Main_Domain') if ('Main_Domain' in _header_tokens) else -1 }}"
    _idx_keylen: "{{ _header_tokens.index('KeyLength') if ('KeyLength' in _header_tokens) else -1 }}"
    _idx_created: "{{ _header_tokens.index('Created') if ('Created' in _header_tokens) else -1 }}"
    _idx_renew: "{{ _header_tokens.index('Renew') if ('Renew' in _header_tokens) else -1 }}"
    _rows_tokens: >-
      {{
        (_all_lines[1:])
        | map('regex_findall', _token_re)
        | map('map','regex_replace','^\"(.*)\"$','\\1')
        | list
      }}
    _now: "{{ ansible_date_time.iso8601 }}"
  ansible.builtin.set_fact:
    acme_list_details: >-
      {%- set out = {} -%}
      {%- for row in _rows_tokens -%}
      {%-   if (_idx_domain|int) >= 0 and (row|length) > (_idx_domain|int) -%}
      {%-     set d = row[_idx_domain] -%}
      {%-     set kl = (row[_idx_keylen] if ((_idx_keylen|int) >= 0 and (row|length) > (_idx_keylen|int)) else '') -%}
      {%-     set created = (row[_idx_created] if ((_idx_created|int) >= 0 and (row|length) > (_idx_created|int)) else '') -%}
      {%-     set renew = (row[_idx_renew] if ((_idx_renew|int) >= 0 and (row|length) > (_idx_renew|int)) else '') -%}
      {%-     set is_ecc = (kl | lower) is search('^ec[-_]?\\d+') -%}
      {%-     set days = (
              ((renew | to_datetime) - (_now | to_datetime)).days
            ) if (renew | length) > 0 else none -%}
      {%-     set _ = out.update({
                d: {
                  'keylength': kl,
                  'is_ecc': is_ecc,
                  'created': created,
                  'renew': renew,
                  'days_until_renew': days
                }
              }) -%}
      {%-   endif -%}
      {%- endfor -%}
      {{ out }}
  changed_when: false

# -------------------------------------------------------------------------
# PARSER: OLD FORMAT (pipe-table)
# -------------------------------------------------------------------------
- name: Parse OLD acme.sh --list format
  when:
    - acme_list is defined
    - _is_pipe_table
  vars:
    _lines: >-
      {{
        _all_lines
        | select('match', '^\\|')
        | map('regex_replace', '^\\|\\s*', '')
        | map('regex_replace', '\\s*\\|$', '')
        | map('split', '|')
        | map('map', 'trim')
        | list
      }}
    _header: "{{ _lines[0] }}"
    _rows: "{{ _lines[1:] }}"
    _idx_domain: "{{ _header.index('Main_Domain') if ('Main_Domain' in _header) else (_header.index('Main Domain') if ('Main Domain' in _header) else -1) }}"
    _idx_created: "{{ _header.index('Created') if ('Created' in _header) else -1 }}"
    _idx_renew: "{{ _header.index('Renew') if ('Renew' in _header) else -1 }}"
    _idx_days: "{{ _header.index('Days_remaining') if ('Days_remaining' in _header) else -1 }}"
    _idx_keylen: "{{ _header.index('KeyLength') if ('KeyLength' in _header) else -1 }}"
    _now: "{{ ansible_date_time.iso8601 }}"
  ansible.builtin.set_fact:
    acme_list_details: >-
      {%- set out = {} -%}
      {%- for row in _rows -%}
      {%-   if (_idx_domain|int) >= 0 and (row|length) > (_idx_domain|int) -%}
      {%-     set d = row[_idx_domain] -%}
      {%-     set kl = (row[_idx_keylen] if ((_idx_keylen|int) >= 0 and (row|length) > (_idx_keylen|int)) else '') -%}
      {%-     set created = (row[_idx_created] if ((_idx_created|int) >= 0 and (row|length) > (_idx_created|int)) else '') -%}
      {%-     set renew = (row[_idx_renew] if ((_idx_renew|int) >= 0 and (row|length) > (_idx_renew|int)) else '') -%}
      {%-     set is_ecc = (kl | lower) is search('^ec[-_]?\\d+') -%}
      {%-     set days = (
              (row[_idx_days] | int)
            ) if ((_idx_days|int) >= 0 and (row|length) > (_idx_days|int) and (row[_idx_days] | length) > 0) else (
              (((renew | to_datetime) - (_now | to_datetime)).days) if (renew | length) > 0 else none
            ) -%}
      {%-     set _ = out.update({
                d: {
                  'keylength': kl,
                  'is_ecc': is_ecc,
                  'created': created,
                  'renew': renew,
                  'days_until_renew': days
                }
              }) -%}
      {%-   endif -%}
      {%- endfor -%}
      {{ out }}
  changed_when: false

# -------------------------------------------------------------------------
# DERIVED FLAT MAP: { domain: days_until_renew }
# -------------------------------------------------------------------------
- name: Derive simple map of domain -> days_until_renew
  when: acme_list_details is defined
  ansible.builtin.set_fact:
    acme_list_days_until_renew: >-
      {%- set out = {} -%}
      {%- for k,v in (acme_list_details | default({})).items() -%}
      {%-   set _ = out.update({ k: v.days_until_renew }) -%}
      {%- endfor -%}
      {{ out }}
  changed_when: false
