---
# ============================================================================
# acme-summary-compact.yml
# ----------------------------------------------------------------------------
# Purpose:
#   Produces the final compact report summarizing actual ACME operations per host.
#   Displays the results of certificate installation, renewal, removal, and failure.
#
# Scope:
#   Runs once after all domain tasks complete (post-loop summary).
#   Compares final scoreboard data to the preflight plan when available.
#
# Notes:
#   - Shows domain-by-domain status (‚úÖ installed / ‚ôªÔ∏è renewed / ‚ö†Ô∏è failed / üóëÔ∏è removed).
#   - Includes optional plan delta comparison when acme_plan_summary is defined.
#   - Warnings from dual-cert detection are merged into the output.
#   - Used as the final report task in tasks/main.yml.
#
# Version: 2025.11.07 / compatible with acme.sh ‚â• 3.0.8
# Maintainer: KevDog
# Tags: [acme, letsencrypt, summary, postflight, report]
# ============================================================================


# Compact end-of-role summary with optional plan delta comparison
# Requires:
#   - acme_summary (always initialized at play start)
#   - acme_plan_summary (from acme-plan.yml)
#   - acme_sh_show_plan_deltas (defaults to true in defaults/main.yml)

- name: SUMMARY ‚Äî compact end-of-role overview
  vars:
    installed: "{{ acme_summary.installed | default([]) }}"
    renewed:   "{{ acme_summary.renewed | default([]) }}"
    removed:   "{{ acme_summary.removed | default([]) }}"
    skipped:   "{{ acme_summary.skipped | default([]) }}"
    failed:    "{{ acme_summary.failed | default([]) }}"
    warnings:  "{{ acme_summary.warnings | default([]) }}"
    uninstalled: "{{ acme_summary.uninstalled | default([]) }}"
    skipped_absent: "{{ (acme_summary.skipped | default([])) | selectattr('status','equalto','already_absent') | list }}"
    skipped_other:  "{{ (acme_summary.skipped | default([])) | rejectattr('status','equalto','already_absent') | list }}"
  ansible.builtin.debug:
    msg: |
      ================================
      üîπ **ACME.SH SUMMARY ‚Äî COMPACT**
      ================================

      ‚úÖ Installed: {{ installed | length }}
      üîÅ Renewed: {{ renewed | length }}
      üóëÔ∏è Removed: {{ removed | length }}
      ‚è≠Ô∏è Skipped: {{ skipped_other | length }}
      üßæ Already absent: {{ skipped_absent | length }}
      ‚ùå Failed: {{ failed | length }}
      ‚ö†Ô∏è  Warnings: {{ warnings | length }}
      üö´ Uninstalled: {{ 'Yes' if (uninstalled is defined and uninstalled | length > 0) else 'No' }}

      {% if installed %}
      ‚úÖ **Installed**
      {% for e in installed %}
        - {{ e.domain }}
      {% endfor %}
      {% endif %}

      {% if renewed %}
      üîÅ **Renewed**
      {% for e in renewed %}
        - {{ e.domain }} ({{ e.new_days_remaining | default('?') }} days left)
      {% endfor %}
      {% endif %}

      {% if removed %}
      üóëÔ∏è **Removed**
      {% for e in removed %}
        - {{ e.domain }}
      {% endfor %}
      {% if ansible_verbosity | int >= 2 %}
      ‚Ü≥ Removed domains: {{ removed | map(attribute='domain') | join(', ') }}
      {% endif %}
      {% endif %}

      {% if skipped_other %}
      ‚è≠Ô∏è **Skipped**
      {% for e in skipped_other %}
        - {{ e.domain }}{% if e.message is defined %} ‚Üí {{ e.message }}{% endif %}
      {% endfor %}
      {% endif %}
      
      {% if skipped_absent %}
      üßæ **Already absent**
      {% for e in skipped_absent %}
        - {{ e.domain }}
      {% endfor %}
      {% endif %}

      {% if failed %}
      ‚ùå **Failed**
      {% for e in failed %}
        - {{ e.domain }}
      {% endfor %}
      {% endif %}

      {% if warnings %}
      ‚ö†Ô∏è **Warnings**
      {% for w in warnings %}
        - {{ w.domain }} ‚Üí {{ w.message }}
      {% endfor %}
      {% endif %}

      {% if acme_summary.filter_tests is defined %}
      üß™ **Filter Plugin Tests**
        ‚Üí Result: {{ '‚úÖ PASSED' if acme_summary.filter_tests.status == 'passed' else '‚ùå FAILED' }}
      {% endif %}
  tags: summary


# ======================================================================
# ENRICHED REMOVAL SUMMARY (added section)
# ======================================================================
- name: SUMMARY ‚Äî removal overview (enriched)
  vars:
    removed: "{{ acme_summary.removed | default([]) }}"
    failed: "{{ acme_summary.failed | default([]) }}"
    uninstalled: "{{ acme_summary.uninstalled | default([]) }}"
    removed_domains: >-
      {{
        removed | map(attribute='domain') | join(', ')
        if removed | length > 0 else 'None'
      }}
    failed_removals: >-
      {{
        failed | map(attribute='domain') | join(', ')
        if failed | length > 0 else 'None'
      }}
  ansible.builtin.debug:
    msg: >-
      {{
        [
          "üóëÔ∏è Removed certificates: " ~ (removed | length | default(0)),
          "‚ùå Failed removals: " ~ (failed | length | default(0)),
          "üö´ acme.sh uninstalled: " ~ (
            'Yes' if (uninstalled is defined and uninstalled | length > 0) else 'No'
          )
        ]
        +
        (
          ansible_verbosity | int >= 2
          | ternary(
              [
                "   ‚Ü≥ Removed domains: " ~ removed_domains,
                "   ‚Ü≥ Failed removals: " ~ failed_removals
              ],
              []
            )
        )
      }}
  when:
    - (acme_summary.removed | default([]) | length) > 0
      or (acme_summary.failed | default([]) | length) > 0
      or (acme_summary.uninstalled | default([]) | length) > 0
    - ansible_run_tags is not defined
      or 'all' in ansible_run_tags
      or 'remove' in ansible_run_tags
      or 'remove_all' in ansible_run_tags
      or 'teardown' in ansible_run_tags
      or 'summary' in ansible_run_tags
      
  tags: [summary]

# ======================================================================
# PLAN vs ACTUAL DELTAS
# ======================================================================
- name: SUMMARY ‚Äî planned vs actual deltas
  when:
    - acme_sh_show_plan_deltas | default(true) | bool
    - acme_plan_summary is defined
  vars:
    _planned_keys: "{{ acme_plan_summary.keys() | list }}"
    _actual_keys: "{{ (acme_summary.installed + acme_summary.renewed + acme_summary.removed + acme_summary.failed) | map(attribute='domain') | list }}"
    _missing: "{{ _planned_keys | difference(_actual_keys) }}"
    _extra: "{{ _actual_keys | difference(_planned_keys) }}"
  ansible.builtin.debug:
    msg: |
      ================================
      üß≠ **PLAN vs ACTUAL**
      ================================
      {% if not _missing and not _extra %}
      ‚úÖ All planned actions were executed successfully.
      {% endif %}

      {% if _missing %}
      ‚ö†Ô∏è  **Missing (planned but not processed):**
      {% for d in _missing %}
        - {{ d }}
      {% endfor %}
      {% endif %}

      {% if _extra %}
      ‚öôÔ∏è  **Extra (processed but not planned):**
      {% for d in _extra %}
        - {{ d }}
      {% endfor %}
      {% endif %}
  tags: summary

# ======================================================================
# TIMESTAMP FOOTER (single run per play)
# ======================================================================
- name: SUMMARY ‚Äî report timestamp
  ansible.builtin.debug:
    msg: "üìÖ Summary generated at: {{ ansible_date_time.iso8601 }} on {{ inventory_hostname }}"
  run_once: true
  tags: summary
