---
# ---------------------------------------------------------------------------
# ACME SUMMARY REPORT â€” with Plan vs Actual comparison
# ---------------------------------------------------------------------------

- name: ğŸ§¾ Summarize ACME Certificate Results (Plan vs Actual)
  vars:
    plan_data: "{{ acme_plan_summary | default({}) }}"
  ansible.builtin.debug:
    msg: |
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸ§¾ ACME.SH CERTIFICATE SUMMARY for {{ inventory_hostname }}
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      {% set total = (
          acme_summary.installed | length +
          acme_summary.renewed | length +
          acme_summary.skipped | length +
          acme_summary.failed | length
      ) %}
      ğŸ§  Processed domains: {{ total }}

      âœ… Installed: {{ acme_summary.installed | length }}
      ğŸ” Renewed:   {{ acme_summary.renewed | length }}
      â­ï¸  Skipped:   {{ acme_summary.skipped | length }}
      âŒ Failed:    {{ acme_summary.failed | length }}
      --------------------------------------------------------------------

      {% macro validity_text(days) -%}
        {% set d = (days | int) %}
        {% if d == -1 %}
          n/a
        {% elif d <= 10 %}
          {{ d }} days ğŸ”´ (URGENT)
        {% elif d <= 30 %}
          {{ d }} days ğŸŸ¡ (RENEW SOON)
        {% else %}
          {{ d }} days âœ…
        {% endif %}
      {%- endmacro %}

      {% macro compare_plan(domain, actual_status) -%}
        {% set expected = plan_data.get(domain, {}).get('action', 'UNKNOWN') %}
        {% if expected == 'REMOVE' and actual_status in ['failed'] %}
          Planned REMOVE â†’ âŒ FAILED
        {% elif expected == 'REMOVE' and actual_status not in ['failed'] %}
          Planned REMOVE â†’ âœ… REMOVED
        {% elif expected in ['INSTALL','RENEW'] and actual_status in ['installed','renewed'] %}
          Planned {{ expected }} â†’ âœ… SUCCESS
        {% elif expected in ['INSTALL','RENEW'] and actual_status in ['failed'] %}
          Planned {{ expected }} â†’ âŒ FAILED
        {% else %}
          Planned {{ expected }} â†’ â­ï¸ SKIPPED
        {% endif %}
      {%- endmacro %}

      {% for cat, emoji, label in [
          ('installed', 'âœ…', 'INSTALLED'),
          ('renewed', 'ğŸ”', 'RENEWED'),
          ('skipped', 'â­ï¸', 'SKIPPED'),
          ('failed', 'âŒ', 'FAILED')
      ] %}
      {% if acme_summary[cat] | length > 0 %}
      {{ emoji }} {{ label }}
      {% for d in acme_summary[cat] %}
        â–¶ {{ d.domain }}
           Domains: {{ d.domains | join(', ') }}
           Status: {{ label }} {{ emoji }}
           {{ compare_plan(d.domain, cat) }}
           Validity: {{ validity_text(d.new_days_remaining | default(-1)) }}
           Cert path: {{ d.live_cert_path | default('n/a') }}
           {% if cat == 'failed' %}
           Return codes: issue={{ d.rc_issue }}, pkcs={{ d.rc_pkcs }}, deploy={{ d.rc_deploy }}
           {% endif %}
      {% endfor %}
      --------------------------------------------------------------------
      {% endif %}
      {% endfor %}

      ğŸ•“ Report generated: {{ ansible_date_time.iso8601 }}
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  when: acme_summary is defined
  tags: summary

