---
- name: Validate custom CLI flag filters
  hosts: localhost
  gather_facts: false

  vars:
    base_cmd: "acme.sh --issue -d example.com --ecc"
    extra_flags: "--force --debug"

    # Expected outcomes for comparison
    expected_has_force: true
    expected_has_staging: false
    expected_added_staging: "acme.sh --issue -d example.com --ecc --staging"
    expected_removed_force: "acme.sh --issue -d example.com --ecc --debug"
    expected_removed_both: "acme.sh --issue -d example.com --ecc"
    expected_ensured_deduped: "acme.sh --issue -d example.com --ecc --force --debug"

  tasks:

    # ---------------------------------------------------------
    # ğŸ” Test has_flag()
    # ---------------------------------------------------------
    - name: ğŸ” Test has_flag filter
      ansible.builtin.set_fact:
        test_has_force: "{{ extra_flags | has_flag('--force') }}"
        test_has_staging: "{{ extra_flags | has_flag('--staging') }}"
        test_has_any: "{{ extra_flags | has_flag(['--force', '--debug']) }}"

    # ---------------------------------------------------------
    # â• Test add_flag_if_missing()
    # ---------------------------------------------------------
    - name: â• Test add_flag_if_missing filter
      ansible.builtin.set_fact:
        test_added_staging: "{{ base_cmd | add_flag_if_missing('--staging') }}"

    # ---------------------------------------------------------
    # ğŸ§© Test ensure_flags_present() with duplicate protection
    # ---------------------------------------------------------
    - name: ğŸ§© Test ensure_flags_present filter
      ansible.builtin.set_fact:
        test_ensured: "{{ base_cmd | ensure_flags_present(['--force', '--debug']) }}"
        test_ensured_duplicate: "{{ (base_cmd ~ ' --force') | ensure_flags_present(['--force']) }}"

    # ---------------------------------------------------------
    # ğŸ§¹ Test remove_flag()
    # ---------------------------------------------------------
    - name: ğŸ§¹ Test remove_flag filter
      ansible.builtin.set_fact:
        test_removed_force: "{{ (base_cmd ~ ' --force --debug') | remove_flag('--force') }}"
        test_removed_both: "{{ (base_cmd ~ ' --force --debug') | remove_flag(['--force', '--debug']) }}"

    # ---------------------------------------------------------
    # ğŸ“Š Display test results
    # ---------------------------------------------------------
    - name: ğŸ“Š Print test results
      ansible.builtin.debug:
        msg:
          - "has_flag('--force') â†’ {{ test_has_force }}"
          - "has_flag('--staging') â†’ {{ test_has_staging }}"
          - "add_flag_if_missing('--staging') â†’ {{ test_added_staging }}"
          - "ensure_flags_present(['--force','--debug']) â†’ {{ test_ensured }}"
          - "ensure_flags_present duplicate check â†’ {{ test_ensured_duplicate }}"
          - "remove_flag('--force') â†’ {{ test_removed_force }}"
          - "remove_flag(['--force','--debug']) â†’ {{ test_removed_both }}"

    # ---------------------------------------------------------
    # âœ… Automated Validation
    # ---------------------------------------------------------
    - name: âœ… Evaluate pass/fail for all tests
      ansible.builtin.set_fact:
        filter_tests_passed: >-
          {{
            (test_has_force == expected_has_force)
            and (test_has_staging == expected_has_staging)
            and (test_added_staging == expected_added_staging)
            and (test_removed_force == expected_removed_force)
            and (test_removed_both == expected_removed_both)
            and (test_ensured == expected_ensured_deduped)
            and (test_ensured_duplicate == base_cmd ~ ' --force')
          }}

    # ---------------------------------------------------------
    # ğŸ§¾ Final Summary
    # ---------------------------------------------------------
    - name: ğŸ§¾ Summary
      ansible.builtin.debug:
        msg: |
          {% if filter_tests_passed %}
          âœ… All filter tests PASSED (no duplicates, correct additions/removals)
          {% else %}
          âŒ Some tests FAILED
            - has_flag('--force'): expected {{ expected_has_force }}, got {{ test_has_force }}
            - has_flag('--staging'): expected {{ expected_has_staging }}, got {{ test_has_staging }}
            - add_flag_if_missing('--staging'): expected "{{ expected_added_staging }}", got "{{ test_added_staging }}"
            - ensure_flags_present(['--force','--debug']): expected "{{ expected_ensured_deduped }}", got "{{ test_ensured }}"
            - ensure_flags_present duplicate check: expected "{{ base_cmd ~ ' --force' }}", got "{{ test_ensured_duplicate }}"
            - remove_flag('--force'): expected "{{ expected_removed_force }}", got "{{ test_removed_force }}"
            - remove_flag(['--force','--debug']): expected "{{ expected_removed_both }}", got "{{ test_removed_both }}"
          {% endif %}

# ---------------------------------------------------------
# ğŸª£ Export filter test status for global summary
# ---------------------------------------------------------
- name: Record filter test outcome in global summary
  ansible.builtin.set_fact:
    acme_summary: >-
      {{
        acme_summary
        | combine({
            'filter_tests': {
              'status': 'passed' if filter_tests_passed else 'failed'
            }
          }, recursive=True)
      }}
  when: filter_tests_passed is defined
  tags: summary

